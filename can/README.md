# CAN总线协议
### 帧数据分层
* 数据帧：携带数据从发送器到接收器
* 远程帧：总线单元发送远程帧，请求发送具有同一标识符的数据帧
* 错误帧：任何单元检测到一总线错误时发出的错误帧
* 超载帧：用来再先行和后续的数据帧之间提供附加的延时。

### 数据帧
* 帧起始位场 仅包含一个显性位，当空闲时，总线保持隐形位，当出现显性位表示数据开始传输
* 仲裁场
    * 标识符
    * 远程发送请求位（RTR）：在数据帧为显性，再远程帧为隐形
    - 标准格式：11位标识符+RTR(RTR=0)位组成
    - 扩展格式：29位标识符+SRR+标识位IDE+远程发送请求位RTR(RTR=1)
        * SRR 替换远程请求位,是一个隐性位，在扩展帧被发送，并代替标准帧的RTR位
        * IDE 标识符扩展位，显性位，而拓展格式为隐形
* 控制场 6个位组成
    * 保留位 2个位
    * 长度码
    - 标准格式 帧包含 数据长度代码 和 IDE位 和 r0 IDE为显性位
    - 拓展格式 帧包含 数据长度代码 和 两个保留位r1和r0，保留位为星星
* 数据场
    * 0-8个字节，首先发送最高位MSB
* CRC场
    * 15位CRC序列和1位隐性CRC界定符组成
    * 用途：用于检测报文传输错误，CRC校验是由硬件完成
* 应答场 长度2个位，包含应答间隙 和 应答界定符
    1. 发送站发送2个隐性位，接收器收到2个隐形位，并正确的接收到有效报文
    2. 接收器会再应答间隙间，向发送器发送1个显性位以示应答
    3. 发送站收到匹配的CRC系列，会砸间隙间用1显性位写入隐形位作为应答
* 帧结尾 7个隐性位标识结尾

### 远程帧
* 通过发送远程帧，对数据传输进行初始化设置
* 组成部分：帧起始，仲裁场，控制场，CRC，应答场，帧结束。
* 与数据帧相比，远程帧的RTR位为隐形，没有数据域

### 错误帧
1. 的错误标识
    * 激活错误标志 6个连续的显性位组成 Active
    * 认可错误标志 6个连续的隐形位组成 Passive
2. 分界符
    * 8个隐性位组成。

### 超载帧
* 过载标识域
* 过载界定符域

### 帧空间
包含：
* 间歇场
* 总线空闲的位场

### 错误类型
* 5种错误类型
1. 位错误 Bit Error：在仲裁场之外，发送数据和接收数据不一致。
2. 填充规则错误 Stuff Error：报文只要出现连续五个相同的位，就会额外插入一个相反的位，如果出现六个连续相同的位，则报错
3. CRC校验 CRC Error：发送端发送前会生成CRC校验码，并写入数据末尾，接收端接收数据后，计算CRC校验码，不匹配，报错。
4. 格式错误 Form Error：固定格式出现非法位
5. 错误应答 Acknowledgement Error：应答场中，发送端2个隐性位，应答端应该写入一个隐性位，但是没写，报错

### 错误界定
* 当出现错误时，本地错误计数，且发送错误帧到总线，
* CAN总线每个节点有两个错误寄存器：接收错误计数器和发送错误计数器
* 主动错误状态：计数器小于127
* 被动错误状态：计数器127-255
* 离线装填：计数器大于255 不在参与数据传输